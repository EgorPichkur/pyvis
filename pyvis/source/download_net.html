<!DOCTYPE html>
<html>
<head>
    <!-- bootstrap style sheet -->
    <link rel="stylesheet" type="text/css" href="../static/css/bootstrap.min.css">
    <!-- general styling -->
    <link href="../static/favicon.ico" rel="icon" type="image/x-icon" />
    <link rel="stylesheet" href="../static/css/vis.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" type="text/css" />
    <link rel="stylesheet" href="../static/css/dashboard.css">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.16.1/vis-network.min.js"> </script>
    <script type="text/javascript" src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script
  src="https://code.jquery.com/jquery-3.2.1.min.js"
  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
  crossorigin="anonymous"></script>

    <style type="text/css">
        #mynetwork {
            width: 90%;
            height: 500px;
            border: 1px solid lightgray;
            align: center;
        }
    </style>

</head>
<body>
<div id="mynetwork"></div>
<script type="text/javascript">
    var draw_graph = function (nodes, edges, options) {


        var allNodes;
        var container = document.getElementById("mynetwork");
        var origNodes = [];
        var origEdges = [];

        var py_nodes = nodes.slice();
        var py_edges = edges.slice();

        // push original (unmodified) node objects onto list
        for (var nid in nodes) {
            origNodes.push(nodes[nid]);
        }

        var nodes = new vis.DataSet(nodes);
        var edges = new vis.DataSet(edges);
        var i = 0;
        var x = 0;
        var y = -1000;
        var step = 70;

        // get the edges and nodes
        allNodes = nodes.get({ returnType: "Object" });
        allEdges = edges.get({ returnType: "Object" });

        // make a deep copy of original edges object
        allEdgesCopy = jQuery.extend(true, {}, allEdges);

        // push original edge objects to list (need this later)
        for (var e in allEdgesCopy) {
            // explicitly give each edge object the color it deserves (based on source node)
            allEdgesCopy[e].color = allNodes[allEdgesCopy[e]["from"]].color;
            origEdges.push(allEdgesCopy[e]);
        }


        var data = { nodes: nodes, edges: edges };

        var network = new vis.Network(container, data, options);
        
        function getFamilyData(selectedNode) {
            var selectedNodePrefix;
            var goodNodes = [];
            var nodesToDim = [];
            
            // iterate through the selected node's name and find the prefix
            for (i = selectedNode.length; i > 0; --i) {
                if (selectedNode[i] == "_") {
                    selectedNodePrefix = selectedNode.substring(0, i);
                    break;
                }
            }

            // go through all the nodes in the network and identify the ones
            // that are a superstring of selectedNodePrefix
            for (var node in allNodes) {
                var currNode = allNodes[node]["id"];

                if (currNode.includes(selectedNodePrefix)) {
                    // currNode here is a "good" node. Leave this here for
                    // potential future uses
                    console.log(currNode);
                    goodNodes.push(currNode);
                }
                else {
                    // add non prefix nodes to a list of nodes to eventually gray out
                    allNodes[node].color = 'rgba(200,200,200,0.5)';
                    nodesToDim.push(allNodes[node]);
                }
            }

            return {
                famNodes: goodNodes,
                nodesToDim: nodesToDim,
                prefix: selectedNodePrefix
            }

        }


        function getClicked(params) {
            // if the user clicks off a node, update with original node settings
            nodes.update(origNodes);

            // re-color the edges to original
            edges.update(origEdges);


            // if the selection was a node
            if (params.nodes.length > 0) {
                // capture the node
                var selectedNode = params.nodes[0];
                var edgesToDim = [];

                var familyData = getFamilyData(selectedNode);

                var nodesToDim = familyData.nodesToDim;
                var famNodes = familyData.famNodes;

                // grey out every edge
                for (var e in allEdges) {
                    allEdges[e].color = 'rgba(200,200,200,0.5)';
                    edgesToDim.push(allEdges[e]);
                }

                edges.update(edgesToDim);

                // grey out the unnecesseary nodes given by the nodesToDim list
                nodes.update(nodesToDim);
            }
            else {
                $(".custom-menu").hide();
                // if the user clicks off a node, update with original node settings
                nodes.update(origNodes);

                // re-color the edges to original
                edges.update(origEdges);
            }
        }


        network.on("click", getClicked);

        function isLeafNode(clicked_node, currData) {
            var updatedNodes = [];
            var outEdges = 0;
            var del_edge_1;
            var del_edge_2;
            var canvasNodes;
            console.log("you right clicked " + clicked_node);
            // if leaf node, remove. otherwise this should be not clickable
            for(var k in allEdges) {
                if(allEdges[k]['from'] == clicked_node || allEdges[k]['to'] == clicked_node) {
                    if(outEdges > 1) {
                        break;
                    }
                    outEdges++;
                    del_edge_1 = k;
                    del_edge_2 = k;
                }
            }
            if(outEdges == 1) {
                return {
                    remove: true,
                    del_edge_1: del_edge_1,
                    del_edge_2: del_edge_2 
                };
            }
            else {
                return {
                    remove: false
                };
            }
        }


        // this handles the right click callback
        // dont really know what to do with the
        // right clicked node at this point
        network.on("oncontext", function (params) {

            var clicked_node = this.getNodeAt(params.pointer.DOM);

            // save clicked node context data
            var thisData = this;

            // if node is clicked prevent default context menu and override with custom 
            if(clicked_node) {

                var is_leaf = isLeafNode(clicked_node, thisData);

                if(is_leaf.remove) {
                    $(".rm_node").removeClass("disabled");
                    
                }
                else {
                     $(".rm_node").addClass("disabled");
                }

                params.event.preventDefault();

                // Show contextmenu
                $(".custom-menu").finish().toggle(100).

                // In the right position (the mouse)
                css({
                    top: event.pageY + "px",
                    left: event.pageX + "px"
                });

                $(".custom-menu li").unbind();

                // If the menu element is clicked
                $(".custom-menu li").click(function() {
                    
                    // This is the triggered action name
                    switch($(this).attr("data-action")) {
                        
                    // contingency table action
                    case "ctable":
                        // iterate through the selected node's name and find the prefix
                        for (i = clicked_node.length; i > 0; --i) {
                            if (clicked_node[i] == "_") {
                                clicked_node_prefix = clicked_node.substring(0, i);
                                break;
                            }
                        }
                        var goodNodes = [];


                        for (var node in allNodes) {
                            var currNode = allNodes[node]["id"];

                            if (currNode.includes(clicked_node_prefix)) {
                                // currNode here is a "good" node. Leave this here for
                                // potential future uses
                                console.log(currNode);
                                goodNodes.push(currNode);
                            }

                        }

                        var edges_to_send = thisData.body.data.edges._data;
                        var net_obj = thisData;
                        contingency_table(clicked_node_prefix, goodNodes);
                        break;
                    case "rm-node":
                        var goodNodes = [];
                        // update the current data struct to reflect removed edges and nodes
                        // this allows iterative removing 
                        if(is_leaf.remove) {

                            thisData.body.data.nodes.remove({id: clicked_node});

                            // remove node from global node data
                            for(var i = 0; i < origNodes.length; ++i) {
                                if(clicked_node == origNodes[i]["id"]) {
                                    origNodes.splice(i, 1);
                                }
                            }

                            delete allEdges[is_leaf.del_edge_1];
                            delete allEdges[is_leaf.del_edge_2];
                            delete allNodes[clicked_node];    
                        }

                        $(".custom-menu").hide();
                        break;

                    case "rm-node-fam":
                        
                        // iterate through the selected node's name and find the prefix
                        for (i = clicked_node.length; i > 0; --i) {
                            if (clicked_node[i] == "_") {
                                clicked_node_prefix = clicked_node.substring(0, i);
                                break;
                            }
                        }

                        uncheck_question(clicked_node_prefix);
                         
                        var famData = getFamilyData(clicked_node);
                        var family = famData.famNodes;
                        if(prefix.indexOf(famData.prefix) == - 1) {
                            prefix.push(famData.prefix);
                        }
                        console.log("Family of " + clicked_node + ": " + family);
                        // make ajax request here
                        remove_family(prefix);
                        break;
                    }
                    
                    // Hide it AFTER the action was triggered
                    $(".custom-menu").hide(100);
                });
            }
        });

        network.fit(options);


        return { 'click_node': getClicked, 'question_list': questions, 'nodes': nodes, 'edges': edges, 'py_data': {"nodes": py_nodes, "edges": py_edges}};
    };

    var options = {
        nodes: {
            shape: "dot"
        }
    }

    draw_graph([{"title": "Category: quality<br>Question [q6_4]: in your opinion, which age group has the lowest quality of life in america these days?<br>Answer: 70-100 year olds (Silent & Greatest Generations)<br>VCnt: 1047<br>VPct: 35.55", "color": "#004D43", "value": 104.7, "label": "q6_4", "shape": "dot", "id": "q6_4"}, {"title": "Category: quality<br>Question [q6_5]: in your opinion, which age group has the lowest quality of life in america these days?<br>Answer: Or there are no differences<br>VCnt: 483<br>VPct: 16.40", "color": "#004D43", "value": 48.3, "label": "q6_5", "shape": "dot", "id": "q6_5"}, {"title": "Category: quality<br>Question [q6_1]: in your opinion, which age group has the lowest quality of life in america these days?<br>Answer: 18-34 year olds (Millennials)<br>VCnt: 1026<br>VPct: 34.84", "color": "#004D43", "value": 102.6, "label": "q6_1", "shape": "dot", "id": "q6_1"}, {"title": "Category: quality<br>Question [q6_2]: in your opinion, which age group has the lowest quality of life in america these days?<br>Answer: 35-50 year olds (Generation X)<br>VCnt: 215<br>VPct: 7.30", "color": "#004D43", "value": 21.5, "label": "q6_2", "shape": "dot", "id": "q6_2"}, {"title": "Category: quality<br>Question [q6_3]: in your opinion, which age group has the lowest quality of life in america these days?<br>Answer: 51-69 year olds (Baby Boomers)<br>VCnt: 174<br>VPct: 5.91", "color": "#004D43", "value": 17.4, "label": "q6_3", "shape": "dot", "id": "q6_3"}, {"title": "Category: quality<br>Question [q4_2]: how would you rate your quality of life these days?<br>Answer: Fair<br>VCnt: 418<br>VPct: 13.83", "color": "#004D43", "value": 41.8, "label": "q4_2", "shape": "dot", "id": "q4_2"}, {"title": "Category: quality<br>Question [q4_3]: how would you rate your quality of life these days?<br>Answer: Good<br>VCnt: 981<br>VPct: 32.45", "color": "#004D43", "value": 98.1, "label": "q4_3", "shape": "dot", "id": "q4_3"}, {"title": "Category: quality<br>Question [q4_1]: how would you rate your quality of life these days?<br>Answer: Poor<br>VCnt: 80<br>VPct: 2.65", "color": "#004D43", "value": 8, "label": "q4_1", "shape": "dot", "id": "q4_1"}, {"title": "Category: quality<br>Question [q4_4]: how would you rate your quality of life these days?<br>Answer: Very good<br>VCnt: 1130<br>VPct: 37.38", "color": "#004D43", "value": 113, "label": "q4_4", "shape": "dot", "id": "q4_4"}, {"title": "Category: quality<br>Question [q4_5]: how would you rate your quality of life these days?<br>Answer: Excellent<br>VCnt: 414<br>VPct: 13.70", "color": "#004D43", "value": 41.4, "label": "q4_5", "shape": "dot", "id": "q4_5"}, {"title": "Category: quality<br>Question [q5_3]: in your opinion, which age group has the highest quality of life in america these days?<br>Answer: 51-69 year olds (Baby Boomers)<br>VCnt: 1197<br>VPct: 40.07", "color": "#004D43", "value": 119.7, "label": "q5_3", "shape": "dot", "id": "q5_3"}, {"title": "Category: quality<br>Question [q5_2]: in your opinion, which age group has the highest quality of life in america these days?<br>Answer: 35-50 year olds (Generation X)<br>VCnt: 813<br>VPct: 27.22", "color": "#004D43", "value": 81.3, "label": "q5_2", "shape": "dot", "id": "q5_2"}, {"title": "Category: quality<br>Question [q5_1]: in your opinion, which age group has the highest quality of life in america these days?<br>Answer: 18-34 year olds (Millennials)<br>VCnt: 282<br>VPct: 9.44", "color": "#004D43", "value": 28.2, "label": "q5_1", "shape": "dot", "id": "q5_1"}, {"title": "Category: quality<br>Question [q5_5]: in your opinion, which age group has the highest quality of life in america these days?<br>Answer: Or there are no differences<br>VCnt: 458<br>VPct: 15.33", "color": "#004D43", "value": 45.8, "label": "q5_5", "shape": "dot", "id": "q5_5"}, {"title": "Category: quality<br>Question [q5_4]: in your opinion, which age group has the highest quality of life in america these days?<br>Answer: 70-100 year olds (Silent & Greatest Generations)<br>VCnt: 237<br>VPct: 7.93", "color": "#004D43", "value": 23.7, "label": "q5_4", "shape": "dot", "id": "q5_4"}], [{"to": "q4_2", "from": "q6_4", "id": "422f7200-53ca-410a-8c18-5cd5ae82b2ee", "value": 151}, {"to": "q5_2", "from": "q6_4", "id": "e273a65b-e33d-4527-a48f-bb15e6805472", "value": 435}, {"to": "q5_1", "from": "q6_4", "id": "73b81d37-2f53-4ebe-9ad6-966775004432", "value": 173}, {"to": "q4_1", "from": "q6_4", "id": "34d35dc8-de53-47b6-97e3-34be2ac7fed4", "value": 23}, {"to": "q4_4", "from": "q6_4", "id": "b4877bdb-94d2-43cb-855f-e0c26a96c01e", "value": 393}, {"to": "q4_4", "from": "q6_5", "id": "b1c45b22-a40d-490c-a10c-127847bc1c96", "value": 184}, {"to": "q5_5", "from": "q6_5", "id": "3245a50a-3ef0-4604-b1ee-fa4316d9614f", "value": 305}, {"to": "q5_3", "from": "q6_1", "id": "82fc7ea6-dd5b-450f-b2d9-7a2d639874c9", "value": 561}, {"to": "q5_4", "from": "q6_1", "id": "4faa4f84-4d82-458d-8ddc-19621e6af44f", "value": 143}, {"to": "q5_3", "from": "q6_2", "id": "9f7774d3-9a73-45cf-8d32-579db7e576d2", "value": 123}, {"to": "q5_2", "from": "q6_3", "id": "bc8c3a44-a0c1-4bf4-8aef-02bcee3b31ce", "value": 73}, {"to": "q5_3", "from": "q4_3", "id": "f32c51ae-52d5-4a2c-b6b1-2ca0980bf142", "value": 375}, {"to": "q5_3", "from": "q4_4", "id": "47324ded-704e-49e9-b9c2-81d9ec27143c", "value": 501}, {"to": "q5_3", "from": "q4_5", "id": "9b72c276-a2e6-4c6b-bf53-a9408fca747a", "value": 179}], options)

</script>